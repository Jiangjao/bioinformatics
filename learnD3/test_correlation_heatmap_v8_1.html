<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<head>
    <title>Document</title>
    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <noscript>抱歉，你的浏览器不支持 JavaScript!</noscript>

    <style>
        svg .container {
            width: 100%;
            height: 100%;
            margin: auto;
        }

        * {
            margin: 0;
            padding: 0;
        }

        .tooltip {
            position: absolute;
            background-color: #f9f9f9;
            padding: 8px;
            border: 1px solid #ccc;
            pointer-events: none;
            font-size: 14px;
        }

        .basicSettings {
            /* width: 80%; */
            position: relative;
            /* top: 38px; */
            z-index: 1;
            overflow-y: auto;
        }

        .downloadSettings {
            width: 100%;
            position: relative;
            /* top: 18px; */
            z-index: 2;
        }

        .sidebar {
            width: 100%;
            display: none;
            /* 初始状态下隐藏下拉框 */
        }

        /* .sidebar {
  width: 300px;
  padding: 20px;    
  border: 1px so    lid #ddd;
  border-radius: 4px;
} */

        .sidebar h2 {
            /* margin-bottom: 10px; */
            /* border-bottom: 1px solid #ddd; */
            padding-bottom: 5px;
        }

        .sidebar label {
            /* width: 120px; */
            /* text-align: right; */
            margin-right: 10px;
        }

        .sidebar input,
        .sidebar select {
            padding: 5px;
            border: 1px solid #ccc;
            width: 25%;
            border-radius: 4px;
        }

        .sidebar button {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            background: #42b983;
            color: #fff;
            cursor: pointer;
        }

        .sidebar button:hover {
            opacity: 0.8;
        }

        .sidebar input[type="number"] {
            width: 50px;
        }

        .sidebar input[type="text"] {
            width: 36%;
        }

        .sidebar input[type="range"] {
            width: 100%;
            /* transform: rotate(270deg); 添加垂直滚动条 */
        }

        /* .sidebar br {
            display: none;
        } */

        .item {
            display: flex;
            align-items: center;
            text-align: justify;
            justify-content: space-between;
            margin-bottom: 10px;
            width: 88%;
        }

        /* .item {} */

        .sidebar hr {
            overflow: hidden;
            width: 88%;
        }

        /* 设置hr线 */
        .item+hr {
            margin: 10px 0;

        }

        .item+hr:first-child {
            margin-top: 0;
        }

        .item+hr {
            border: none;
            border-top: 1px dotted #ccc;
        }

        /* hr {} */
        /* .item label {
            width: 120px;
            } */
        /* .sidebar {
            display: flex;
            flex-wrap: wrap;
        } */

        .sliderTooltip {
            /* display: block; */
            /* position: absolute; */
            /* styles */
            /* padding: 10px; */
            position: absolute;
            /* top: -30px; */
            /* left: 134px; */
            background-color: rgb(204 204 204 / 18%);
            /* color: #f9f9f9; */
            padding: 5px;
            border-radius: 5px;
            display: none;
            margin-top: 14%;
        }

        .tooltip.show {
            display: block;
        }

        .sidebar.show {
            width: 100%;
            height: auto;
            position: relative;
            /* padding: inherit; */
            display: block;
            padding: 10px 11px;
            /* 点击后显示下拉框 */
            transition: max-height 0.3s ease;
            z-index: 1;
            /* 添加过渡效果 */
        }

        .show {
            max-height: 500px;
            transition: max-height 0.5s;
        }

        /* 添加button的样式 */
        .button-like {
            display: inline-block;
            padding: 10px 0 10px 10%;
            background-color: #4CAF50;
            color: white;
            text-align: left;
            text-decoration: none;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            width: 90%;
        }

        .button-like:hover {
            background-color: #45a049;
        }

        .button-like:active {
            background-color: #3e8e41;
        }

        /* TODO:xiaojiao, @media screen and (max-width: 700px) 如何使用2023/10/23 */
        div.tooltip-donut {
            position: absolute;
            text-align: center;
            padding: .5rem;
            background: #FFFFFF;
            color: #313639;
            border: 1px solid #313639;
            border-radius: 8px;
            pointer-events: none;
            font-size: 1.3rem;
        }

        /*手机屏幕下样式*/
        @media screen and (max-width: 700px) {

            div.tooltip-donut {
                position: relative;
                padding: 10px 15px;
                font-size: 14px;
            }

            div.tooltip-donut::after {
                content: none;
            }

        }

        icon-i {
            text-align: center;
        }

        .dropdown {
            /* padding: 10px 11px; */
            position: relative;
            /* display: inline-block; */
        }

        .dropdown-content {
            display: none;
            position: relative;
            /* top: 100%; */
            /* left: 0; */
            width: 100%;
            /* padding: 10px 11px; */
            background-color: #4CAF50;
        }


        .settingContent {
            display: block;
            position: relative;
            /* top: 100%; */
            /* left: 0; */
            width: 90%;
            padding: 10px 11px;
            /* overflow-y: scroll; */
            height: 60vh;
            overflow-y: scroll;
            /* 设置垂直方向上溢出时显示滚动条 */
            overflow-x: hidden;
            scrollbar-width: thin;
            /* 设置滚动条的宽度 */
            scrollbar-color: gray lightgray;
            /* 设置滚动条的颜色 */
        }

        /* div#settingContent {} */
        /* .dropdown:hover .dropdown-content {
        display: block;

         } */

        .filled {
            fill: url("#mainGradient");
        }

        .ticks text {
            font-family: sans-serif;
            font-size: 17px;
            text-anchor: start;
        }
    </style>
</head>

<body>
    <div style="position: absolute; width:100%; height: 100%;">
        <div>
            <div style="width: 20%;z-index: 1; position: fixed; padding-right: 1%; right:0; top:40px; opacity: 0.9;">
                <!-- add by xiaojiao 停靠右侧， x轴文本旋转 -->
                <!-- add by xiaojiao 柱状图宽度调整 -->
                <div class="dropdown">
                    <div id="dropdownTest" class="downloadSettings" style="background:#F9F9F9;width: 100%;">
                        <p class="button-like">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                class="bi bi-cloud-arrow-down" viewBox="0 0 16 16">
                                <path fill-rule="evenodd"
                                    d="M7.646 10.854a.5.5 0 0 0 .708 0l2-2a.5.5 0 0 0-.708-.708L8.5 9.293V5.5a.5.5 0 0 0-1 0v3.793L6.354 8.146a.5.5 0 1 0-.708.708l2 2z" />
                                <path
                                    d="M4.406 3.342A5.53 5.53 0 0 1 8 2c2.69 0 4.923 2 5.166 4.579C14.758 6.804 16 8.137 16 9.773 16 11.569 14.502 13 12.687 13H3.781C1.708 13 0 11.366 0 9.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383zm.653.757c-.757.653-1.153 1.44-1.153 2.056v.448l-.445.049C2.064 6.805 1 7.952 1 9.318 1 10.785 2.23 12 3.781 12h8.906C13.98 12 15 10.988 15 9.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 4.825 10.328 3 8 3a4.53 4.53 0 0 0-2.941 1.1z" />
                            </svg>
                            download
                        </p>
                    </div>
                    <div id="dropdownContent" class="dropdown-content"
                        style="background:#F9F9F9;width: 100%;display: none;">
                        <div class="sidebar show">
                            <button id="export">下载 SVG</button>
                            <!-- <br> -->
                        </div>
                    </div>
                </div>

                <!-- <br> -->
                <div class="dropdown" style="background:#F9F9F9;width: 100%;">
                    <div class="basicSettings">
                        <!-- <button type="button" id="exitBtn" class="btn" onClick="exitFullscreen()">退出全屏</button> -->
                        <p type="button" id="btn" class="btn button-like" title="fullscreen">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                class="bi bi-gear" viewBox="0 0 16 16">
                                <path title="修改参数"
                                    d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z" />
                                <path title="修改参数"
                                    d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z" />
                            </svg>
                            <path title="fullscreen" fill-rule="evenodd"
                                d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344 0a.5.5 0 0 1 .707 0l4.096 4.096V11.5a.5.5 0 1 1 1 0v3.975a.5.5 0 0 1-.5.5H11.5a.5.5 0 0 1 0-1h2.768l-4.096-4.096a.5.5 0 0 1 0-.707zm0-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707zm-4.344 0a.5.5 0 0 1-.707 0L1.025 1.732V4.5a.5.5 0 0 1-1 0V.525a.5.5 0 0 1 .5-.5H4.5a.5.5 0 0 1 0 1H1.732l4.096 4.096a.5.5 0 0 1 0 .707z" />
                            </svg>
                            setting
                        </p>
                    </div>
                    <div class="settingContent" id="settingContent">
                        <div class="sidebar show" id="mainsetting">
                            <!-- <h2>文本 Settings</h2> -->
                            <div class="item">
                                <p>字体选择:</p>
                                <!-- https://www.runoob.com/w3cnote/web-font-family.html -->
                                <select class="form-select" id="fontSelect">
                                    <option value="">Select</option>
                                    <option disabled style="font-weight: bold; background-color: #EEEEEE">Serif Fonts
                                    </option>
                                    <option value="Georgia,serif" style="font-family: Georgia,serif">Georgia</option>
                                    <option value="Palatino Linotype,Book Antiqua,Palatino,serif"
                                        style="font-family: Palatino Linotype,Book Antiqua,Palatino,serif">Palatino
                                        Linotype</option>
                                    <option value="Times New Roman,Times,serif"
                                        style="font-family: Times New Roman,Times,serif">Times New Roman</option>
                                    <option disabled style="font-weight: bold; background-color: #EEEEEE">Sans-Serif
                                        Fonts</option>
                                    <option value="Arial,Helvetica,sans-serif"
                                        style="font-family: Arial,Helvetica,sans-serif">Arial</option>
                                    <option value="Arial Black,Gadget,sans-serif"
                                        style="font-family: Arial Black,Gadget,sans-serif">Arial Black</option>
                                    <option value="Comic Sans MS,cursive,sans-serif"
                                        style="font-family: Comic Sans MS,cursive,sans-serif">Comic Sans MS</option>
                                    <option value="Impact,Charcoal,sans-serif"
                                        style="font-family: Impact,Charcoal,sans-serif">Impact</option>
                                    <option value="Lucida Sans Unicode,Lucida Grande,sans-serif"
                                        style="font-family: Lucida Sans Unicode,Lucida Grande,sans-serif">Lucida Sans
                                        Unicode</option>
                                    <option selected="selected" value="Tahoma,Geneva,sans-serif"
                                        style="font-family: Tahoma,Geneva,sans-serif">Tahoma</option>
                                    <option value="Trebuchet MS,Helvetica,sans-serif"
                                        style="font-family: Trebuchet MS,Helvetica,sans-serif">Helvetica</option>
                                    <option value="Verdana,Geneva,sans-serif"
                                        style="font-family: Verdana,Geneva,sans-serif">Verdana</option>
                                    <option disabled style="font-weight: bold; background-color: #EEEEEE">Monospace
                                        Fonts</option>
                                    <option value="Courier New,Courier,monospace"
                                        style="font-family: Courier New,Courier,monospace">Courier New</option>
                                    <option value="Lucida Console,Monaco,monospace"
                                        style="font-family: Lucida Console,Monaco,monospace">Lucida Console</option>
                                    <option disabled style="font-weight: bold; background-color: #EEEEEE">中文</option>
                                    <option value="华文细黑,sans-serif" style="font-family: 华文细黑,sans-serif">华文细黑</option>
                                    <option value="微软雅黑,sans-serif" style="font-family: 微软雅黑,sans-serif">微软雅黑</option>
                                    <option value="中易宋体,sans-serif" style="font-family: 中易宋体,sans-serif">中易宋体</option>
                                    <option value="WenQuanYi Micro Hei,sans-serif"
                                        style="font-family: WenQuanYi Micro Hei,sans-serif">WenQuanYi Micro Hei</option>
                                    <option value="楷体,serif" style="font-family: 楷体, serif">楷体</option>
                                    <option value="隶书,sans-serif" style="font-family: 隶书, sans-serif">隶书</option>
                                </select>
                            </div>

                            <div class="item">
                                <p>字体大小: </p>
                                <input type="range" id="fontSizeRange" min="6" max="56" step="1" value="16">
                                <div class="sliderTooltip">
                                    <span class="value"></span>
                                </div>
                            </div>

                            <div class="item">
                                <p>圆圈大小: </p>
                                <input type="range" id="slider" min="1" max="56" step="1" value="16">
                                <!-- <div class="sliderTooltip">
                                    <span class="value"></span>
                                </div> -->
                            </div>

                            <div class="item">
                                <p>线条大小: </p>
                                <input type="range" id="lineslider" min="0.1" max="20" step="0.1" value="2">
                                <!-- <div class="sliderTooltip">
                                    <span class="value"></span>
                                </div> -->
                            </div>

                            <div class="item">
                                <label>线条x轴平移: </label>
                                <input type="range" id="lineXposlider" min="-1000" max="1000" step="1" value="2">
                                <!-- <div class="sliderTooltip">
                                    <span class="value"></span>
                                </div> -->
                            </div>

                            <div class="item">
                                <label>线条y轴平移: </label>
                                <input type="range" id="lineYposlider" min="-1000" max="1000" step="1" value="2">
                                <!-- <div class="sliderTooltip">
                                    <span class="value"></span>
                                </div> -->
                            </div>
                            <div class="item">
                                <label>相关性文字修改: </label>
                                <input type="text" id="envCor_name_change" value="Env-cor">
                            </div>
                            <hr>
                            <div class="item">
                                <label for="axisColor">外边框颜色:</label>
                                <input type="color" id="axisColor" value="#000000">
                            </div>
                            <div class="item">
                                <label for="EnvcorstartColor">EnvCor startColor:</label>
                                <input type="color" id="EnvcorstartColor" value="#ff0000">
                            </div>

                            <div class="item">
                                <label for="EnvcorendColor">EnvCor endColor:</label>
                                <input type="color" id="EnvcorendColor" value="#0000ff">
                            </div>

                            <div class="item">
                                <label for="startColor">MantelP startColor:</label>
                                <input type="color" id="startColor" value="#ff0000">
                            </div>

                            <div class="item">
                                <label for="endColor">MantelP endColor:</label>
                                <input type="color" id="endColor" value="#0000ff">
                            </div>
                            <div class="item">
                                <button id="applySettings">Apply Settings</button>
                            </div>

                            <hr>

                            <div class="item">
                                <button id="center-button">reset</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="dropdown" style="background:#F9F9F9;width: 100%;">
                    <div class="basicSettings">
                        <!-- <button type="button" id="exitBtn" class="btn" onClick="exitFullscreen()">退出全屏</button> -->
                        <p type="button" id="helpbtn" class="btn button-like" title="fullscreen">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                class="bi bi-question-square" viewBox="0 0 16 16">
                                <path
                                    d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z" />
                                <path title="fullscreen" fill-rule="evenodd"
                                    d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286m1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94" />
                            </svg>
                            help
                        </p>
                    </div>
                    <div class="settingContent" id="helpContent">
                        <div class="sidebar show" id="helpsetting">
                            <!-- <h2>文本 Settings</h2> -->
                            <!-- <div class="item"> -->
                            <h3>基本的使用</h3>
                            <ol>
                                <li>可以拖拽移动图形</li>
                                <li>鼠标放大缩小图像</li>
                                <li>悬浮到特定图案上会有文字展示</li>
                            </ol>


                            <h2>原理</h2>

                            <p>
                                Mantel test是一种统计学检验方法,用于检验两个矩阵之间的相关性。原理是:
                            </p>

                            <ol>
                                <li>
                                    对两个矩阵分别计算其距离矩阵,如Bray-Curtis距离和欧氏距离
                                </li>

                                <li>
                                    将两个距离矩阵降维为距离值向量
                                </li>

                                <li>
                                    计算距离值向量的相关性,如皮尔逊相关系数
                                </li>

                                <li>
                                    随机置换 repeating steps 1-3,看实际相关系数在随机置换下的置信区间位置
                                </li>
                            </ol>
                            <h3>Mantel r值和Mantel p值在Mantel检验中分别代表:</h3>
                            <p>Mantel r值:</p>
                            <ol>
                                <li>即Mantel相关系数(Mantel's rho),它表示两个距离矩阵中距离信息的相关程度。</li>
                                <li>值范围从-1到1,绝对值越大相关程度越强。正值表示距离越近样本越相似,负值则相反。</li>
                            </ol>
                            <p>Mantel p值:</p>
                            <ol>
                                <li>它是Mantel相关系数显著性的衡量指标。通过随机置换实验计算得到。</li>
                                <li>如果p值小于选择的显著性水平α(通常为0.05),则表明两个矩阵距离相关系数不可能是随机产生的,两矩阵距离信息相关性显著。</li>
                            </ol>
                            <p>比如:Mantel r = 0.8, p值 = 0.001</p>
                            <p>则可以说明:</p>
                            <ol>
                                <li>两个矩阵距离相关程度很高,Mantel r值为0.8</li>
                                <li>相关系数极不可能由随机产生,因为p值远小于0.05水平,两矩阵距离信息显著相关。</li>
                            </ol>
                            <p>所以:Mantel r反映两个矩阵的距离相关强弱,Mantel
                                p检验此相关系数的显著性,低p值支持其显著性。两者结合可以充分评价Mantel检验结果和两个矩阵距离信息的关联程度。</p>
                            <h2>应用</h2>

                            <ul>
                                <li>测试环境因子与微生物群落结构之间的相关性</li>
                                <li>测试两个种群基因变异之间的相关性</li>
                                <li>测试地理分布图与动态模型之间的相关性</li>
                            </ul>
                            <ol>
                                <li>
                                    <cite><a href="https://doi.org/10.1111/2041-210x.12018">更加具体和详细的内容可以参考 （Dismantling
                                            the Mantel tests）</a></cite>

                                </li>
                                <li>
                                    <cite><a href="https://www.bilibili.com/read/cv18682729/">【R 语言可视化】Mantel_test
                                            的实现与绘图</a></cite>

                                </li>

                            </ol>

                            <!-- </div> -->
                        </div>
                    </div>
                </div>
                <!-- <br> -->
                <!-- <br> -->
                <div class="btns" id="btns" style="background:#F9F9F9;width: 100%;">

                    <!-- <button type="button" id="exitBtn" class="btn" onClick="exitFullscreen()">退出全屏</button> -->
                    <p type="button" id="btn" class="btn button-like fullScreen" title="fullscreen">
                        <svg title="fullscreen" xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                            fill="currentColor" class="bi bi-arrows-fullscreen" viewBox="0 0 16 16">
                            <path title="fullscreen" fill-rule="evenodd"
                                d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344 0a.5.5 0 0 1 .707 0l4.096 4.096V11.5a.5.5 0 1 1 1 0v3.975a.5.5 0 0 1-.5.5H11.5a.5.5 0 0 1 0-1h2.768l-4.096-4.096a.5.5 0 0 1 0-.707zm0-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707zm-4.344 0a.5.5 0 0 1-.707 0L1.025 1.732V4.5a.5.5 0 0 1-1 0V.525a.5.5 0 0 1 .5-.5H4.5a.5.5 0 0 1 0 1H1.732l4.096 4.096a.5.5 0 0 1 0 .707z" />
                        </svg>
                        全屏
                    </p>
                </div>
            </div>


            <div class="basicSettings" style="margin-left: auto; position: relative;">

            </div>


        </div>
        <!-- Create a div where the graph will take place -->
        <div id="container">
            <svg id="chart">

            </svg>
        </div>

    </div>
    <!-- particle source code:https://d3-graph-gallery.com/graph/heatmap_tooltip.html -->
    <script>

        var tableData = {
            "colnames": ['SL', 'SM', 'SW', 'Yield', 'Starch', 'Protein', 'Solublesugars', 'SOM', 'AN', 'AP', 'AK', 'pH', 'CEC'],
            "rownames": ['SL', 'SM', 'SW', 'Yield', 'Starch', 'Protein', 'Solublesugars', 'SOM', 'AN', 'AP', 'AK', 'pH', 'CEC'],
            "data": [
                [1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.8210576858123295, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.8705892711689287, 0.9329146104170898, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.824566479341442, 0.8811188811188813, 0.830435353969758, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.8541313718020874, 0.833626497322632, 0.812421193401995, 0.9106844088398501, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.7398956945034544, 0.8126107032724816, 0.7982613468938993, 0.9422080999150758, 0.8596491228070177, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.4780323726958185, 0.6409817185295869, 0.4708148963941845, 0.7075317330217298, 0.775438596491228, 0.5982456140350878, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.8280752728705546, 0.7762237762237763, 0.6926184228854153, 0.8181818181818183, 0.6795106742881959, 0.6514896155546621, 0.4903685278368424, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.9193039046274801, 0.8951048951048951, 0.9117120056348833, 0.8741258741258742, 0.9281975705483089, 0.8266212326392487, 0.612960659796053, 0.6923076923076924, 1.0, 0.0, 0.0, 0.0, 0.0], [0.7929873375794294, 0.8811188811188813, 0.8056989817238502, 0.9510489510489512, 0.8511396590310907, 0.8931712471313915, 0.5919448657459025, 0.8391608391608393, 0.8181818181818183, 1.0, 0.0, 0.0, 0.0], [0.7684257828756417, 0.8741258741258742, 0.7668275396231382, 0.8951048951048951, 0.9071817764981586, 0.7635738504887974, 0.8021028062474065, 0.7552447552447553, 0.8601398601398602, 0.8461538461538463, 1.0, 0.0, 0.0], [0.8014072130488722, 0.8056054385890983, 0.757551788183124, 0.7145369977051133, 0.636842105263158, 0.5508771929824562, 0.3087719298245614, 0.8616475560561659, 0.7390554240969553, 0.8021028062474066, 0.7250448947301884, 1.0, 0.0], [0.8386016534578921, 0.8181818181818183, 0.8198340515786545, 0.7342657342657343, 0.7075317330217298, 0.6409817185295869, 0.3047290137271806, 0.7762237762237763, 0.8041958041958043, 0.8321678321678322, 0.6643356643356644, 0.9422080999150758, 1.0]],
            // Mantel P > 0; math.abs(Mantel R )  <= 1
            "linkData": [['Sucrase', 'SL', '0.7329', '0.001', '>= 0.4', '< 0.01'], ['Sucrase', 'SM', '0.8280000000000001', '0.001', '>= 0.4', '< 0.01'], ['Sucrase', 'SW', '0.5599000000000001', '0.001', '>= 0.4', '< 0.01'], ['Sucrase', 'Yield', '0.9137000000000001', '0.001', '>= 0.4', '< 0.01'], ['Sucrase', 'Starch', '0.5565', '0.001', '>= 0.4', '< 0.01'], ['Sucrase', 'Protein', '0.10350000000000001', '0.28600000000000003', '< 0.2', '>= 0.05'], ['Sucrase', 'Solublesugars', '0.265', '0.033', '0.2 - 0.4', '0.01 - 0.05'], ['Sucrase', 'SOM', '0.6934', '0.001', '>= 0.4', '< 0.01'], ['Sucrase', 'AN', '0.8251000000000001', '0.001', '>= 0.4', '< 0.01'], ['Sucrase', 'AP', '0.7787000000000001', '0.002', '>= 0.4', '< 0.01'], ['Sucrase', 'AK', '0.5998', '0.001', '>= 0.4', '< 0.01'], ['Sucrase', 'pH', '0.47790000000000005', '0.008', '>= 0.4', '< 0.01'], ['Sucrase', 'CEC', '0.7549', '0.001', '>= 0.4', '< 0.01'], ['Urease', 'SL', '0.6412', '0.001', '>= 0.4', '< 0.01'], ['Urease', 'SM', '0.4985', '0.011', '>= 0.4', '0.01 - 0.05'], ['Urease', 'SW', '0.5007', '0.003', '>= 0.4', '< 0.01'], ['Urease', 'Yield', '0.5883', '0.002', '>= 0.4', '< 0.01'], ['Urease', 'Starch', '0.27390000000000003', '0.065', '0.2 - 0.4', '>= 0.05'], ['Urease', 'Protein', '0.051800000000000006', '0.424', '< 0.2', '>= 0.05'], ['Urease', 'Solublesugars', '-0.1466', '0.887', '< 0.2', '>= 0.05'], ['Urease', 'SOM', '0.31520000000000004', '0.04', '0.2 - 0.4', '0.01 - 0.05'], ['Urease', 'AN', '0.6893', '0.001', '>= 0.4', '< 0.01'], ['Urease', 'AP', '0.431', '0.01', '>= 0.4', '< 0.01'], ['Urease', 'AK', '0.18460000000000001', '0.145', '< 0.2', '>= 0.05'], ['Urease', 'pH', '0.32430000000000003', '0.036000000000000004', '0.2 - 0.4', '0.01 - 0.05'], ['Urease', 'CEC', '0.6118', '0.001', '>= 0.4', '< 0.01'], ['Phosphatase', 'SL', '0.5089', '0.007', '>= 0.4', '< 0.01'], ['Phosphatase', 'SM', '0.5005000000000001', '0.005', '>= 0.4', '< 0.01'], ['Phosphatase', 'SW', '0.2021', '0.095', '0.2 - 0.4', '>= 0.05'], ['Phosphatase', 'Yield', '0.558', '0.005', '>= 0.4', '< 0.01'], ['Phosphatase', 'Starch', '0.6031000000000001', '0.001', '>= 0.4', '< 0.01'], ['Phosphatase', 'Protein', '0.0809', '0.35000000000000003', '< 0.2', '>= 0.05'], ['Phosphatase', 'Solublesugars', '0.0927', '0.23', '< 0.2', '>= 0.05'], ['Phosphatase', 'SOM', '0.37220000000000003', '0.019', '0.2 - 0.4', '0.01 - 0.05'], ['Phosphatase', 'AN', '0.4186', '0.011', '>= 0.4', '0.01 - 0.05'], ['Phosphatase', 'AP', '0.3453', '0.023', '0.2 - 0.4', '0.01 - 0.05'], ['Phosphatase', 'AK', '0.4339', '0.003', '>= 0.4', '< 0.01'], ['Phosphatase', 'pH', '0.34', '0.029', '0.2 - 0.4', '0.01 - 0.05'], ['Phosphatase', 'CEC', '0.3865', '0.016', '0.2 - 0.4', '0.01 - 0.05'], ['Catalase', 'SL', '0.7207', '0.001', '>= 0.4', '< 0.01'], ['Catalase', 'SM', '0.41140000000000004', '0.004', '>= 0.4', '< 0.01'], ['Catalase', 'SW', '0.4894', '0.003', '>= 0.4', '< 0.01'], ['Catalase', 'Yield', '0.6245', '0.001', '>= 0.4', '< 0.01'], ['Catalase', 'Starch', '0.26990000000000003', '0.082', '0.2 - 0.4', '>= 0.05'], ['Catalase', 'Protein', '0.1296', '0.187', '< 0.2', '>= 0.05'], ['Catalase', 'Solublesugars', '0.13240000000000002', '0.19', '< 0.2', '>= 0.05'], ['Catalase', 'SOM', '0.4315', '0.02', '>= 0.4', '0.01 - 0.05'], ['Catalase', 'AN', '0.8968', '0.001', '>= 0.4', '< 0.01'], ['Catalase', 'AP', '0.488', '0.004', '>= 0.4', '< 0.01'], ['Catalase', 'AK', '0.5964', '0.001', '>= 0.4', '< 0.01'], ['Catalase', 'pH', '0.1322', '0.19', '< 0.2', '>= 0.05'], ['Catalase', 'CEC', '0.6422', '0.003', '>= 0.4', '< 0.01']]
        }
        const rawData = tableData.data.reverse();
        const linkData = tableData.linkData;


        // Labels of row and columns
        // TODO:xiaojiao, 注意x label 和 y 轴方向的 label
        var myGroups = tableData.colnames;
        var myVars = tableData.rownames.reverse();

        // Labels of row and columns
        // TODO:xiaojiao, 注意x label 和 y 轴方向的 label
        // var myGroups = ["v1", "v2", "v3", "v4", "v5"];
        // var myVars = ["v1", "v2", "v3", "v4", "v5"].reverse();

        const formattedData = [];
        // TODO:xiaojiao, 需要更改这个每组的大小
        const groupSize = rawData.length; // 每组的大小
        // 循环行
        for (let i = 0; i < groupSize; i++) {
            const row = rawData[i];

            var element = myGroups[i];
            // 循环列
            for (let j = 0; j < row.length; j++) {

                const item = {
                    group: element,
                    variable: myVars[j],
                    value: row[j],
                    visibility: 0,
                    possibility: rawData[j][i]
                };

                formattedData.push(item);
            }
        }


        // TODO:xiaojiao, 监听窗口resize 时的变化
        let flag = true

        // TODO:xiaojiao, adjust the stroke-width of rect
        var stroke_width = 1;

        // 全屏设置
        let isFullscreen = false;

        window.onresize = function () {

            // 全屏时放弃改变窗口大小
            // added by xiaojiao 2023/12/04
            if (isFullscreen) {
                return;
            }

            if (flag) {
                // 
                flag = false
                location.reload();
            }
            let timeId = setTimeout(() => {
                flag = true
                timeId = null // 清除延时定时器
            }, 1000)
            width = document.body.clientWidth;
        }

        // 网页窗口在某一大小打开时的宽高
        // https://stackoverflow.com/questions/16265123/resize-svg-when-window-is-resized-in-d3-js
        var width = window.innerWidth || document.clientWidth || document.body.clientWidth;
        var height = window.innerHeight || document.clientHeight || document.body.clientHeight;

        // set the dimensions and margins of the graph
        const margin = { top: 30, right: 30, bottom: 30, left: 130 };
        width = width - margin.left - margin.right;
        height = height - margin.top - margin.bottom;

        // FIXME:xiapjiao 2023/12/11
        if (width > height) {
            height = height * 1.2;
            width = height;
        } else {
            width = width * 1.2;
            height = width;
        }

        const fontSize = 0.02 * width;
        // append the svg object to the body of the page
        const svg = d3.select("#chart")
            // .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom);
        // .attr("viewBox", [-1, -1, width, height])


        const svgViewbox = svg.append("g")
            .attr("id", "svgViewbox")
            // .attr("width", width + margin.left + margin.right)
            // .attr("height", height + margin.top + margin.bottom)
            .attr("transform", `translate(${margin.left},${margin.top})`);


        // Build X scales and axis:
        const x = d3.scaleBand()
            .range([0, width])
            .domain(myGroups)
            .padding(0.01);

        svgViewbox.append("g")
            // .attr("transform", `translate(0, ${width})`)
            .call(d3.axisTop(x))
            .attr("id", "xaxis")

        // 2024/03/08 添加x 轴text旋转
        d3.select("#xaxis").selectAll("text")
            .attr("transform", "rotate(45)")
            .attr("text-anchor", "end");
        // Build X scales and axis:
        const y = d3.scaleBand()
            .range([height, 0])
            .domain(myVars)
            .padding(0.01);
        svgViewbox.append("g")
            .attr("transform", `translate(${width}, 0)`)
            .call(d3.axisRight(y))
            .attr("id", "yaxis");

        // Build color scale
        const myColor = d3.scaleLinear()
            .range(["white", "#69b3a2"])
            .domain([1, 100])

        // 使用颜色映射
        colortemp2 = d3.scaleSequential([0, 1], d3.interpolateRdYlBu);
        // colortemp2 = d3.scaleLinear([-1, 0, 1], ["red", "white", "green"]);

        colortempLinear = d3.scaleSequential([0, 1], d3.interpolateRgb("purple", "orange"))

        const mantelRWidthMap = d3.scaleLinear([-1, 0, 1], ["10", "5", "10"]);

        const groupedData = [];
        for (let i = 0; i < formattedData.length; i += groupSize) {
            groupedData.push(formattedData.slice(i, i + groupSize));
        }
        // create a tooltip
        const tooltip = d3.select("#container")
            .append("div")
            .style("opacity", 0)
            .attr("class", "tooltip")
            .style("background-color", "white")
            .style("border", "solid")
            .style("border-width", "2px")
            .style("border-radius", "5px")
            .style("padding", "5px")

        // Three function that change the tooltip when user hover / move / leave a cell
        const mouseover = function (event, d) {
            tooltip.style("opacity", 1)
        }
        const mousemove = function (event, d) {
            // 
            tooltip
                .html("The exact value of<br>this cell is: " + d.possibility)
                .style("left", (event.x) / 2 + "px")
                .style("top", (event.y) / 2 + "px")
        }
        const mouseleave = function (d) {
            tooltip.style("opacity", 0)
        }


        // add the squares
        const heatmapOverview = svgViewbox.append("g")
            .attr("id", "heatmap")

        const viewbox = heatmapOverview.append("g")
            .attr("id", "table")


        viewbox
            .selectAll("g")
            .data(groupedData)
            .attr("id", "test")
            .join("g")
            .selectAll("rect")
            .data(d => d, function (d) { return d.group + ':' + d.variable; })
            .enter()
            .append("rect")
            .attr("x", function (d) { return x(d.variable) })
            .attr("y", function (d) { return y(d.group) })
            .attr("width", function (d, i) {
                if (d.visiablity == "0" || d.value == "0" || d.value == "1") {
                    return 0;
                }

                return x.bandwidth() - stroke_width / 2;
                // return y(d.variable) 
            })
            .attr("height", function (d, i) {
                if (d.visiablity == "0" || d.value == "0" || d.value == "1") {
                    return 0;
                }
                return y.bandwidth() - stroke_width / 2;
                // return y(d.variable) 
            })
            .style("fill", function (d) {
                return "white";
                // return myColor(d.value) 
            })
            .attr("stroke", "black")
            .attr("stroke-width", 0.4)
            .on("mouseover", mouseover)
            .on("mousemove", mousemove)
            .on("mouseleave", mouseleave)


        heatmapOverview
            .append("g")
            .attr("id", "row")
            .selectAll("g")
            .data(groupedData)
            .attr("id", "test")
            .join("g")
            .selectAll("rect")
            .data(d => d, function (d) { return d.group + ':' + d.variable; })
            .enter()
            .append("rect")
            .attr("x", function (d) {
                //
                return x(d.variable) + (x.bandwidth() - x.bandwidth() * Math.abs(d.possibility)) / 2;
            })
            .attr("y", function (d) { return y(d.group) + (y.bandwidth() - y.bandwidth() * Math.abs(d.possibility)) / 2; })
            .attr("width", function (d, i) {
                // 
                if (d.visiablity == "0" || d.value == "0" || d.value == "1") {
                    return 0;
                }
                // 
                return Math.abs(d.possibility) * x.bandwidth() - stroke_width / 2;
                // return y(d.variable) 
            })
            .attr("height", function (d, i) {
                if (d.visiablity == "0" || d.value == "0" || d.value == "1") {
                    return 0;
                }
                // 
                return Math.abs(d.possibility) * y.bandwidth() - stroke_width / 2;
                // return y(d.variable) 
            })
            .style("fill", function (d) { return colortemp2((d.possibility + 1) / 2) })
            // .attr("stroke", "black")
            // .attr("stroke-width", 1)
            .on("mouseover", mouseover)
            .on("mousemove", mousemove)
            .on("mouseleave", mouseleave)

        tempX = parseFloat(heatmapOverview.attr("x"));
        tempY = parseFloat(heatmapOverview.attr("y"));

        tempX = d3.select("#chart").node().getBBox().x + x.bandwidth() / 2;
        tempY = d3.select("#chart").node().getBBox().y + y.bandwidth() / 2;


        const numCircles = 4;
        // const tempX = 50;
        // const tempY = 50;

        adjustment = 0.9;
        tempRectWidth = x.bandwidth() * adjustment;
        tempRectCenter = 0;


        // 添加文字
        // heatmapOverview.selectAll("text")
        //     .data(data, function (d) { return d.group + ':' + d.variable; })
        //     .enter()
        //     .append("text")
        //     .attr("x", function (d) { return x(d.variable) + x.bandwidth() / 2; })
        //     .attr("y", function (d) { return y(d.group) + y.bandwidth() / 2; })
        //     .attr("dy", "0.35em")
        //     .text(function (d) { return d.group + " " + " " + d.variable; })
        //     .style("text-anchor", "middle")
        //     .style("fill", "black");

        // TODO:xiaojiao, 获取对角线元素
        var reverseDiagonalElements = [];

        for (let i = 0; i < groupedData.length; i++) {
            reverseDiagonalElements.push(groupedData[i][groupedData.length - 1 - i]);
        }
        var tempbracket = reverseDiagonalElements;
        const newData = [];

        for (let i = 0; i < linkData.length; i++) {
            const item = linkData[i];

            for (let j = 0; j < reverseDiagonalElements.length; j++) {
                const line = reverseDiagonalElements[j];


                console.log("line", line);
                console.log("item", item);

                console.log("line", line);
                console.log("item", item);
                // TODO:xiaojiao, 如何给这个line 添加新属性？？
                if (line.group === item[1]) {
                    // line.temp = 1;
                    const obj = {
                        ...item,
                        ...line,
                    };

                    newData.push(obj);
                    break;
                }
            }
        }

        reverseDiagonalElements = newData;
        // TODO:获取对角线元素坐标
        const getDiagonalCoordinates = () => {
            const coords = []

            reverseDiagonalElements.forEach((d, i) => {
                item = reverseDiagonalElements[i];
                const obj = {
                    ...item,
                };
                // const link = d.link;
                // /
                // x坐标
                const x_pos = x(d.variable)

                // y坐标
                var y_pos = y(d.group)

                // coordinate item
                // const variable = d.variable;

                coords.push({
                    x_pos,
                    y_pos,
                    // variable,
                    // link,
                    ...obj,
                })
            })
            return coords;
        }

        const coordinates = getDiagonalCoordinates();

        // TODO:xiaojiao, 添加dots
        svgViewbox
            .append("g")
            .attr("id", "dots")
            .selectAll("circle")
            .data(coordinates)
            .enter()
            .append("circle")
            .attr("cx", function (d) {

                return d.x_pos + x.bandwidth() / 2;
            }) // 圆心 x 坐标
            .attr("cy", function (d) {
                return d.y_pos + y.bandwidth() / 2;
            })
            .attr("r", 5) // 半径
            .attr("fill", "black"); // 填充颜色

        const dots = [];
        for (let k = 0; k < coordinates.length; k++) {
            // TODO:xiaojiao, 重新绘制这个dots 2023/12/11
            // dots.push([coordinates[k] + x.bandwidth() * 4, coordinates[k][1]]);
            const item = { ...coordinates[k] };

            // item.x_pos -= x.bandwidth() * (groupSize - 1);
            item.y_pos += y.bandwidth() * (groupSize - 1);

            dots.push(item);
        }

        // 提取第一列
        const firstColumn = linkData.map(item => item[0]);

        // 使用Set去除重复
        const uniqueSet = new Set(firstColumn);

        // 转换为数组
        // TODO:xiaojiao, 找到需要添加到OTU
        const uniqueArray = [...uniqueSet];

        sampleLength = uniqueArray.length;
        // /


        // https://zhuanlan.zhihu.com/p/50238441
        // D3.js线段生成器详解


        const crossLines = [];
        // 双重循环，构建坐标数组
        for (let n = 0; n < coordinates.length; n++) {
            // TODO:xiaojiao, 重新绘制这个dots 2023/12/11
            // dots.push([coordinates[k] + x.bandwidth() * 4, coordinates[k][1]]);
            const item_left = { ...coordinates[n] };

            // item_left.x_pos -= x.bandwidth() * (groupSize - 1);
            item_left.y_pos += y.bandwidth() * (groupSize - 1);
            // start
            for (let m = 0; m < coordinates.length; m++) {
                const element = { ...coordinates[m] };
                // y_width descreasment

                y_pos = item_left.y_pos + parseInt(m / groupSize) * y.bandwidth()

                // /
                // element.x_pos -= x.bandwidth() * 4;
                // end
                // element.x_pos -= x.bandwidth() * 4;
                // if ((m % groupSize == 0) && (m != 0)) {
                x_pos = item_left.x_pos + parseInt(m / groupSize) * x.bandwidth()
                // y_pos = element.y_pos - y.bandwidth() * parseInt(m / groupSize);
                // }
                elementsCoordinates = {
                    "x1": element.x_pos,
                    "y1": element.y_pos,
                    "x2": x_pos,
                    "y2": y_pos,
                    // 添加 v4
                    // "variable": element.variable,
                    ...element
                }

                crossLines.push(elementsCoordinates);
            }
        }

        tempX = d3.select("#chart").node().getBBox().x + x.bandwidth() / 2;
        tempY = d3.select("#chart").node().getBBox().y + y.bandwidth() / 2;

        // TODO:xiajiao, crossLines.slice(0, 10)，需要修改这行代码 2023/12/20
        var drawLinegroup = function (colortempLinear) {
            svgViewbox.append("g")
                .attr("id", "lineg")
                .selectAll("line")
                .data(crossLines.slice(0, sampleLength * groupSize))
                .enter()
                .append("line")
                .attr("x1", function (d) { return d.x1 + x.bandwidth() / 2; })
                .attr("y1", function (d) { return d.y1 + y.bandwidth() / 2; })
                .attr("x2", function (d) { return d.x2 + x.bandwidth() / 2; })
                .attr("y2", function (d) { return d.y2 + y.bandwidth() / 2; })
                .attr("stroke", function (d) {
                    return colortempLinear(d[3]);
                    // faile through
                    // return "error";
                })
                .attr("stroke-width", function (d) {
                    return mantelRWidthMap(d[2]);

                })
                .on("mouseover", mouseover)
                .on("mousemove", function (event, d) {
                    let mantelP = d[3];
                    let MantelR = d[2];
                    // for (let i = 0; i < linkData.length; i++) {
                    //     const element = linkData[i];

                    //     if (element[1] === d.variable) {
                    //         // return 20
                    //         result += Math.abs(element[3]);
                    //         lineWidth = element[2];
                    //         break;
                    //         // return colortempLinear(result);
                    //     }
                    // }
                    tooltip
                        .html("The exact Mantel P value color-map of<br>this cell is: " + mantelP + "<br>"
                            + "Mantel R is: " + MantelR)
                        .style("left", (event.x) / 2 + "px")
                        .style("top", (event.y) / 2 + "px")
                })
                .on("mouseleave", mouseleave)
        }

        drawLinegroup(colortempLinear);

        // TODO:xiaojiao, 添加leftlegend
        const leftlegend = svgViewbox
            .append("g")
            .attr("id", "leftlegend")

        leftlegend
            .selectAll("text")
            .data(dots.slice(0, sampleLength))
            // .append("text")
            .enter()
            .append("text")
            .text(function (d, i) {
                return uniqueArray[i];
            })
            .attr("x", d => d.x_pos - fontSize)
            .attr("y", d => (d.y_pos + y.bandwidth() / 2 + parseFloat(20)))
            .style("fill", "black")
            .attr("text-anchor", "end");

        leftlegend.selectAll("circle")
            .data(dots.slice(0, sampleLength))
            .enter()
            .append("circle")
            .attr("cx", function (d) {
                return d.x_pos + x.bandwidth() / 2;
            }) // 圆心 x 坐标
            .attr("cy", function (d) {
                return d.y_pos + y.bandwidth() / 2;
            })
            .attr("r", 5) // 半径
            .attr("fill", "black"); // 填充颜色



        // 添加渐变条带
        // 使用d3.js绘制渐变条
        // https://juejin.cn/post/6844904037486166023
        const nTicks = 5; // 0, 20, 40, 60, 80, 100;
        const textHeight = 22;

        const padding = 50;
        const barHeight = 20;
        var tickFormat = d3.format(".0");

        // ticks类型对象
        const tickTypes = {
            range: {
                generate(nTicks) {
                    return Array.from({ length: nTicks }, (_, i) => {
                        return (i / (nTicks - 1)) * 2 - 1;
                    });
                }
            },

            linear: {
                generate(nTicks) {
                    return Array.from({ length: nTicks }, (_, i) => {
                        return i / (nTicks - 1);
                    });
                }
            }

            // 可以继续添加其他类型
        };

        // 生成ticks函数
        function getTicks(nTicks, type) {
            if (!tickTypes[type]) {
                throw new Error('Invalid tick type');
            }

            return tickTypes[type].generate(nTicks);
        }

        const gradientRectHeight = height * 0.31;
        const gradientRectWidth = width * 0.03;

        // move the
        axisY_tempX = d3.select("#heatmap").node().getBBox().width + x.bandwidth() * 1.5;
        axisY_tempX = axisY_tempX + d3.select("#yaxis").node().getBBox().width * 2 + 150;
        axisY_tempY = d3.select("#heatmap").node().getBBox().height + y.bandwidth() / 2;

        const legend = svgViewbox.append("g")
            .attr("id", "legend")
            .style('transform', 'translate(' + axisY_tempX + 'px, ' + (0 / 2) + 'px)');



        // barHeight = 20;
        // https://stackoverflow.com/questions/62950517/d3-gradient-rectangle-add-points-with-text-on-stops

        var ticks = new Array(nTicks)
            .fill()
            .map(function (e, i) { return (i / (nTicks - 1)) * 2 - 1 });

        const ticksContainer = d3.select("#gradientBar").append('g')
            .classed('ticks', true)
        // .style('transform', 'translate(' + 0 + 'px, ' + (barHeight + 10) + 'px)');

        // ticksContainer
        //     .selectAll('text')
        //     .data(ticks)
        //     .enter()
        //     .append('text')
        //     .text(tickFormat)
        //     .style("font-size", `${fontSize}px`)
        //     .attr('y', function (d, i) {
        //         return (gradientRectHeight / nTicks + fontSize / 2) * i + fontSize / 2;
        //     })
        //     .attr('x', function (d) {
        //         // 
        //         return gradientRectWidth + 30;
        //     });

        // linePath = function (t, e) {
        //     e = e ? Number(e) : 2
        //     return "M " + (t.x - 10) + "," + (t.y - e) + " L " + (t.x + 20) + "," + (t.y - e) + " L " + (t.x + 20) + "," + (t.y + e) + " L " + (t.x - 20) + "," + (t.y + e) + "L " + (t.x - 20) + "," + (t.y - e)
        // }

        function createGradientBar(parentContainer, id, title, colortempLinear, ticks) {
            // 创建defs
            const defs = parentContainer
                .append("g")
                .append("defs");

            // 创建线性渐变
            const linearGradient = defs
                .append("linearGradient")
                .attr("id", id)
                .attr("x1", "0%")
                .attr("y1", "0%")
                .attr("x2", "0%")
                .attr("y2", "100%");

            // 添加渐变环节
            for (let k = 0; k <= 100; k++) {
                const offset = k;
                const stopColor = colortempLinear(k / 100);

                linearGradient
                    .append("stop")
                    .attr("offset", `${offset}%`)
                    .attr("stop-color", stopColor)
                    .attr("text-anchor", "end");
            }

            // 添加矩形使用渐变
            parentContainer.append("rect")
                .attr("height", gradientRectHeight)
                .attr("width", gradientRectWidth)
                .style("fill", "url(#" + id + ")");
            // 创建渐变图块

            const gradientBar = d3.select("#" + id);
            // 添加标题文本
            parentContainer.append("text")
                .text(title)
                .attr("x", 0)
                .attr("y", 0)
                .attr("fill", "black")
                .attr("id", "correName")
                .style('transform', 'translate(' + 0 + 'px, ' + -fontSize + 'px)')
                .attr("text-anchor", "middle")
                .attr("font-size", `${fontSize}px`);

            // const nTicks = 5;

            // ticks
            const ticksContainer = parentContainer.append('g')
                .classed('ticks', true)
            // .style('transform', 'translate(' + 0 + 'px, ' + (barHeight + 10) + 'px)');
            // 创建渐变等操作
            ticksContainer
                .selectAll('text')
                .data(ticks)
                .enter()
                .append('text')
                .text(tickFormat)
                .style("font-size", `${fontSize}px`)
                .attr('x', function (d) {
                    // 
                    return gradientRectWidth + 30;
                })
                .attr('y', function (d, i) {
                    return (gradientRectHeight / nTicks + fontSize / 2) * i + fontSize / 2 + fontSize;
                })
                .attr("text-anchor", "start");
        }
        // padding = 30;
        let line1Y = gradientRectHeight + padding;

        const rangeTicks = getTicks(5, 'range');

        // 调用
        const line0Container = legend.append("g")
            .attr("id", "line0");
        createGradientBar(line0Container, "myGradient11", "Env-cor", colortemp2, rangeTicks);


        // 添加比例尺刻度文本
        // ticks = new Array(nTicks)
        //     .fill()
        //     .map(function (e, i) { return (i / (nTicks - 1)) });
        const linearTicks = getTicks(5, 'linear');
        parentContainer = legend
            .append("g")
            .attr("id", "line1")
            .style('transform', 'translate(' + 0 + 'px, ' + line1Y + 'px)')
        // .attr("transform", `translate(${line1Y} + 180, 0)`)

        createGradientBar(parentContainer, "myGradient1", "Mantel P", colortempLinear, linearTicks);


        const line2 = legend.append("g")
            .attr("id", "line2")
            .style('transform', 'translate(' + 0 + 'px, ' + (axisY_tempY * 1) + 'px)');


        // 选择元素
        // const line2 = d3.select("#line2");

        // 定义绘制矩形+文字函数
        function drawRectText(rectHeight, text) {
            let rectHeightPercent = rectHeight / 598;
            // 长宽
            let rectWidth = 0.06 * width;
            rectHeight = rectHeightPercent * width;
            // 绘制矩形
            const rect = line2.append("rect")
                .attr("class", "rect")
                .attr("width", rectWidth)
                .attr("height", rectHeight)
                .style("fill", "#D1D1D1");

            // 绘制文字
            const line2withtext = line2.append("text")
                .attr("class", "text")
                .text(text)
                .attr("font-size", `${fontSize}px`)
                .style("fill", "black")
                .attr("dy", rectWidth * 0.3)
                .attr("text-anchor", "start");


            // 设置文字位置
            line2withtext.attr("x", rectWidth + 10);

            return {
                rect,
                line2withtext
            };

        }

        mantelR = ["-0.3018", "0.0000", "0.9038"];

        // 循环三次调用绘制函数
        for (let i = 0, mantelLength = mantelR.length; i < mantelLength; i++) {
            var tempMantelelement = mantelR[i];
            const { rect, line2withtext } = drawRectText(mantelRWidthMap(tempMantelelement), ` ${tempMantelelement}`);

            // 设置y坐标
            rect.attr("y", i * 30);
            line2withtext.attr("y", i * 30);

        }


        line2.append('text')
            // .text(tickFormat)
            .text("Mantel R")
            .style("font-size", `${fontSize}px`)
            .attr('y', d3.select("#line2").node().getBBox().y)
            .attr('x', d3.select("#line2").node().getBBox().x - 10)
            .attr("dx", 10);


    </script>

    <script>
        // 创建一个缩放行为，并设置缩放事件处理程序
        const zoom = d3.zoom().on('zoom', (e) => {
            svgViewbox.attr('transform', e.transform);
        });
        d3.select("#chart").call(zoom)
            .call(zoom.transform, d3.zoomIdentity.scale(0.8));

        svgViewbox.attr("transform", `translate(${margin.left},${margin.top}) scale(0.4)`);

        // 字体选择
        const fontSelect = document.getElementById("fontSelect");
        const textElement = d3.select("#container");

        fontSelect.addEventListener("change", function () {
            const selectedFont = fontSelect.value;
            d3.selectAll("text").style("font-family", selectedFont);
            // svg.style("font-family", selectedFont);
        });

        function addEvent(el, type, handler) {
            if (el.addEventListener) {
                el.addEventListener(type, handler);
            } else {
                el.attachEvent('on' + type, handler);
            }
        }

        const fontSizeRange = document.getElementById("fontSizeRange");
        const sliderTooltip = document.querySelector(".sliderTooltip");

        // 嵌套的子元素span中的value
        var valueSpan = document.querySelector(".sliderTooltip .value");

        fontSizeRange.addEventListener("input", function () {
            const selectedFontSize = fontSizeRange.value;
            d3.selectAll("text").style("font-size", selectedFontSize + "px");
            // svg.style("font-size", selectedFontSize + "px");
            const sliderRect = fontSizeRange.getBoundingClientRect();

            const tooltipWidth = sliderTooltip.offsetWidth;
            const tooltipHeight = sliderTooltip.offsetHeight;


            const sliderValue = parseInt(selectedFontSize);
            const sliderMin = parseInt(fontSizeRange.min);
            const sliderMax = parseInt(fontSizeRange.max);
            const sliderWidth = fontSizeRange.offsetWidth;



            // TODO:xiaojiao, fix thar
            // const tooltipX = 1;
            const positionPercentage = (sliderValue - sliderMin) / (sliderMax - sliderMin);
            const tooltipPosition = positionPercentage * (sliderWidth - tooltipWidth);

            const tooltipX = tooltipWidth + tooltipPosition;
            const tooltipY = sliderRect.top - tooltipHeight; // 自定义偏移量，避免与滑块重叠


            sliderTooltip.style.left = tooltipX + "px";
            // sliderTooltip.style.top = -0.1 + "px";

            // var value = valueSpan.textContent;
            valueSpan.textContent = selectedFontSize + 'px';
            // 

            // 
        });

        // 添加slider tooltip
        fontSizeRange.addEventListener("mouseover", function () {

            // tooltip.classList.add()
            sliderTooltip.style.display = "block";

            sliderTooltip.classList.add("show");
        });

        fontSizeRange.addEventListener("mouseout", function () {

            sliderTooltip.classList.remove("show");
            sliderTooltip.style.display = "none";
        });

        // 下载
        // 构建下拉展开
        var dropdownTest = document.getElementById("dropdownTest")
        var dropdownContent = document.getElementById("dropdownContent");

        dropdownTest.addEventListener("click", function () {
            dropdownContent.style.display = (dropdownContent.style.display === "none") ? "block" : "none";

        });

        // 下载
        var svgDownload = d3.select("#chart");
        svgDownload.attr('version', '1.1')
            .attr('xmlns', 'http://www.w3.org/2000/svg')
            .attr('xmlns:xlink', 'http://www.w3.org/1999/xlink');
        // var base64Svg = window.btoa(encodeURIComponent(html).replace(/%([0-9A-F]{2})/g, function (match, p1) {
        //     return String.fromCharCode('0x' + p1);
        // }));
        // 
        // 
        const svgString = new XMLSerializer().serializeToString(svgDownload.node());

        const downloadButton = document.getElementById("export");

        downloadButton.addEventListener("click", () => {
            // 创建一个临时的 SVG 元素用于操作
            const tempSvg = svgDownload.node().cloneNode(true);

            // 查找并移除所有的动画元素
            const animateElements = tempSvg.querySelectorAll("animate, animateTransform, animateMotion");
            animateElements.forEach((animateElement) => {
                animateElement.remove();
            });

            // 将修改后的 SVG 元素转换为字符串
            const modifiedSvgString = new XMLSerializer().serializeToString(tempSvg);

            // 创建下载链接
            const link = document.createElement("a");
            link.href = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(modifiedSvgString);
            link.download = "svg_file.svg";
            link.click();
        });


        // 获取 "Basic Settings" 元素
        const basicSettings = document.querySelector(".basicSettings");

        // icon-i gd-icon-param


        // 获取下拉框元素
        const settingContent = document.querySelector("#settingContent");

        // 添加点击事件监听器
        basicSettings.addEventListener("click", function () {
            // 切换下拉框的显示状态
            // 获取元素的位置信息
            var rect = this.getBoundingClientRect();
            var position = {
                top: rect.top,
                left: rect.left,
                right: rect.right,
                bottom: rect.bottom
            };
            settingContent.style.display = (settingContent.style.display === "none") ? "block" : "none";

        });

        // 按钮点击事件处理函数
        function handleButtonClick(contentElement) {
            // 隐藏所有内容元素
            // downloadDropdown.style.display = "none";
            // settingsDropdown.style.display = "none";
            // content3.style.display = "none";

            // 显示指定的内容元素
            contentElement.style.display = "block";

        }

        const downloadSettings = document.querySelector(".downloadSettings");

        downloadSettings.addEventListener("click", function () {


        });

        const helpBtn = document.getElementById('helpbtn');
        const helpContent = document.getElementById('helpContent');

        helpBtn.addEventListener('click', toggleHelp);

        function toggleHelp() {
            helpContent.classList.toggle('show');
            helpContent.style.display = (helpContent.style.display === "none") ? "block" : "none";
        }
        helpContent.classList.remove('show');

        // FIXME:xiaojiao, 2023/10/31 全屏有些错误
        function toggleFullscreen() {
            if (isFullscreen) {
                exitFullscreen();
            } else {
                fullScreen();
            }

            isFullscreen = !isFullscreen;
        }

        function fullScreen() {
            var de = document.documentElement;
            if (de.requestFullscreen) {
                de.requestFullscreen();
            } else if (de.mozRequestFullScreen) {
                de.mozRequestFullScreen();
            } else if (de.webkitRequestFullScreen) {
                de.webkitRequestFullScreen();
            }
        }

        function exitFullscreen() {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            }
        }

        document.getElementById("btns").addEventListener("click", function () {
            toggleFullscreen();
        })
        //  $("#btn").click(fullScreen()) // 注意会报错


        // 获取输入颜色的元素
        const startColorInput = document.getElementById('startColor');
        const endColorInput = document.getElementById('endColor');

        const EnvcorstartColorInput = document.getElementById('EnvcorstartColor');
        const EnvcorendColorInput = document.getElementById('EnvcorendColor');
        // 环状热图外边框
        // const colorPicker = document.getElementById('colorPicker');
        // const colorValue = document.getElementById('colorValue');
        // colorPicker.addEventListener('change', function () {
        //     colorValue.value = colorPicker.value;
        // });
        const applySettingsButton = document.getElementById("applySettings");

        // 应用设置按钮点击事件处理程序
        applySettingsButton.addEventListener("click", applySettings);

        // 随机产生字符串
        function randomString(length) {
            var result = '';
            var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            var charactersLength = characters.length;
            for (var i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * charactersLength));
            }
            return result;
        }


        // x 轴 y 轴显示
        d3.selectAll('.domain').attr("stroke", "");
        const colorPicker = document.getElementById('axisColor');

        function applySettings() {
            // var compute = d3.interpolate(a, b);
            // 获取rgb颜色的插值
            compute = d3.interpolateRgb(startColorInput.value, endColorInput.value);
            var computeEnv = [EnvcorstartColorInput.value, EnvcorendColorInput.value];
            // computeEnv = d3.interpolateRgb(EnvcorstartColorInput.value, EnvcorendColorInput.value);


            // 更新SVG图形属性
            colorLinear = d3.scaleSequential([0, 1], compute);
            colorLinear2 = d3.scaleSequential([0, 1], computeEnv);

            // 清除图形
            // svg.selectAll('*').remove();
            d3.select("#lineg").remove();

            drawLinegroup(colorLinear);

            // 渐变条
            d3.select("#line1").remove();
            d3.select("#line0").remove();
            // d3.select("svg").select("defs").remove();
            parentContainer = legend
                .append("g")
                .attr("id", "line1")
                .style('transform', 'translate(' + 0 + 'px, ' + line1Y + 'px)')

            createGradientBar(parentContainer, "myGradient" + randomString(10), "Mantel P", colorLinear, linearTicks);
            const line0Container = legend.append("g")
                .attr("id", "line0");

            createGradientBar(line0Container, "myGradient11" + randomString(10), "Env-cor", colorLinear2, rangeTicks);


            // 内部小矩形
            d3.select("#row").remove();
            heatmapOverview
                .append("g")
                .attr("id", "row")
                .selectAll("g")
                .data(groupedData)
                .attr("id", "test")
                .join("g")
                .selectAll("rect")
                .data(d => d, function (d) { return d.group + ':' + d.variable; })
                .enter()
                .append("rect")
                .attr("x", function (d) { return x(d.variable) + (x.bandwidth() - x.bandwidth() * Math.abs(d.possibility)) / 2; })
                .attr("y", function (d) { return y(d.group) + (y.bandwidth() - y.bandwidth() * Math.abs(d.possibility)) / 2; })
                .attr("width", function (d, i) {
                    // 
                    if (d.visiablity == "0" || d.value == "0" || d.value == "1") {
                        return 0;
                    }
                    // 
                    return Math.abs(d.possibility) * x.bandwidth() - stroke_width / 2;
                    // return y(d.variable) 
                })
                .attr("height", function (d, i) {
                    if (d.visiablity == "0" || d.value == "0" || d.value == "1") {
                        return 0;
                    }
                    // 
                    return Math.abs(d.possibility) * y.bandwidth() - stroke_width / 2;
                    // return y(d.variable) 
                })
                .style("fill", function (d) { return colorLinear2((d.possibility + 1) / 2) })
                // .attr("stroke", "black")
                .attr("stroke-width", 1)
                .on("mouseover", mouseover)
                .on("mousemove", mousemove)
                .on("mouseleave", mouseleave)

            // 最外边框颜色
            const color = colorPicker.value;

            d3.selectAll('.domain')
                .style('stroke', color);
        }

        // d3.js 选中所有的圆圈放大
        const circles = d3.selectAll("circle");


        const slider = document.getElementById('slider');

        slider.addEventListener('input', () => {

            // 获取滑块值
            const value = slider.value;

            circles.style("stroke-width", 3)
                .style("fill", "black")
                .transition()
                .duration(1000)
                .attr("r", value);

        });

        // TODO:Xiaojiao, 调整线条粗细
        // lineg
        const linegslider = document.getElementById('lineslider');

        linegslider.addEventListener("change", function () {
            var lineSliderValue = parseFloat(linegslider.value);
            d3.selectAll("#lineg").selectAll("line").style("stroke-width", function (_, i) {
                // console.log("this ", this, this[2]);
                first_line_stroke_width = mantelRWidthMap(_['2']);
                pre_stroke_width = this.getAttribute("stroke-width");
                this.setAttribute("prev_line_Width", pre_stroke_width)
                this.setAttribute('stroke-width', first_line_stroke_width * lineSliderValue * 0.1);
                // console.log(_, i)
            });

            //  更新矩形宽高
            // 
            d3.select("#line2").selectAll("rect").remove()
            for (let i = 0, mantelLength = mantelR.length; i < mantelLength; i++) {
                var tempMantelelement = mantelR[i];
                const { rect, line2withtext } = drawRectText(mantelRWidthMap(tempMantelelement) * lineSliderValue * 0.1, ` ${tempMantelelement}`);

                // 设置y坐标
                rect.attr("y", i * 30);
                line2withtext.attr("y", i * 30);

            }
        })

        // 更新Env-cor文字
        envCor_name_change = document.getElementById("envCor_name_change");
        envCor_name_change.addEventListener("input", function() {
            temp = d3.select("#line0").select("#correName");
            temp.text(envCor_name_change.value)
            // console.log("temp >>>", temp, envCor_name_change.value);
        })

        // 调节线条位置, 沿着x轴方向
        const linesXposlider = document.getElementById('lineXposlider');

        // 调节线条位置, 沿着x轴方向
        const linesYposlider = document.getElementById('lineYposlider');

        linesXposlider.addEventListener("input", function() {
            var linesXposliderValue = parseFloat(linesXposlider.value);
            d3.selectAll("#lineg").selectAll("line").style("stroke-width", function (_, i) {
                // this.setAttribute("x1", _["x1"] + linesXposliderValue)
                this.setAttribute("x2", _["x2"] + linesXposliderValue + x.bandwidth() / 2)
                // console.log("this ", this, this[2]);
                // first_line_stroke_width = mantelRWidthMap(_['2']);
                // pre_stroke_width = this.getAttribute("stroke-width");
                // this.setAttribute("prev_line_Width", pre_stroke_width)
                // this.setAttribute('stroke-width', first_line_stroke_width * linesXposliderValue * 0.1);
                console.log(_, i);
                // 重新画画这个circle
                // if (i % sampleLength == 0 ){
                //     leftlegend.append("circle")
                //                 .attr("cx", _["x2"] + linesXposliderValue)
                //                 .attr("cx", _["y2"] + parseFloat(linesYposlider.value))
                //                 .attr("r", 5)
                //                 .attr("fill", "black");
                // }
                // sampleLength
            });

            // leftlegend
            leftlegend
                .style('transform', 'translate(' + linesXposliderValue + 'px, ' + linesYposlider.value + 'px)')

            // leftlegend.selectAll("circle")
            //     .data(dots.slice(0, sampleLength))
            //     .enter()
            //     .append("circle")
            //     .attr("cx", function (d) {
            //         return d.x_pos + x.bandwidth() / 2 + linesXposliderValue;
            //     }) // 圆心 x 坐标
            //     .attr("cy", function (d) {
            //         return d.y_pos + y.bandwidth() / 2;
            //     })
            //     .attr("r", 5) // 半径
            //     .attr("fill", "black"); // 填充颜色
        
        });


        linesYposlider.addEventListener("input", function() {
            var linesYposliderValue = parseFloat(linesYposlider.value);
            
            // 平移
            leftlegend
            .style('transform', 'translate(' + linesXposlider.value + 'px, ' + linesYposliderValue + 'px)')

            d3.selectAll("#lineg").selectAll("line").style("stroke-width", function (_, i) {
                // this.setAttribute("x1", _["x1"] + linesYposliderValue)
                this.setAttribute("y2", _["y2"] + linesYposliderValue + y.bandwidth() / 2)
                // console.log("this ", this, this[2]);
                // first_line_stroke_width = mantelRWidthMap(_['2']);
                // pre_stroke_width = this.getAttribute("stroke-width");
                // this.setAttribute("prev_line_Width", pre_stroke_width)
                // this.setAttribute('stroke-width', first_line_stroke_width * linesYposliderValue * 0.1);
                // console.log(_, i)
            });
  
        })

        // handleColorChange();
        document.getElementById("center-button").addEventListener("click", function () {
            // resizesvg();
            // resetTransform();
            // svg.call(zoom, d3.zoomIdentity);
            // TODO:xiaojiao, 请支持不同浏览器的刷新, 2023/10/30
            location.reload();
            // window.addEventListener("load", (event) => {
            //     moveSvgAfterload();
            // });
            // resizesvg();
        })

        // 缩放
        d3.select("#chart").call(zoom)
            .call(zoom.transform, d3.zoomIdentity.scale(0.6));

    </script>

</body>

</html>